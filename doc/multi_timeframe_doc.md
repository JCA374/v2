# Multi-Timeframe Technical Analysis with ESG Integration

This document describes the implementation of the Multi-Timeframe Technical Analysis tab, which offers comprehensive stock analysis across three timeframes (long, medium, and short-term) with ESG (Environmental, Social, Governance) data integration.

## Table of Contents

1. [Feature Overview](#feature-overview)
2. [Architecture](#architecture)
3. [Configuration](#configuration)
4. [Technical Indicators](#technical-indicators)
5. [Signal Generation](#signal-generation)
6. [ESG Data Integration](#esg-data-integration)
7. [User Settings](#user-settings)
8. [How to Extend](#how-to-extend)
9. [Performance Considerations](#performance-considerations)

## Feature Overview

The Multi-Timeframe Technical Analysis tab provides:

- **Long-term analysis** (weekly data, 5 years) for identifying major market trends
- **Medium-term analysis** (daily data, 1 year) for swing trading opportunities
- **Short-term analysis** (hourly data, 1 month) for entry/exit timing
- **ESG ratings** to evaluate sustainability factors
- **Trading signals** based on technical indicators
- **Interactive charts** with buy/sell markers
- **User-configurable settings** for indicators and signal thresholds

This approach follows best practices in technical analysis by analyzing multiple timeframes simultaneously to confirm signals and reduce false positives.

## Architecture

The feature follows the app's modular architecture pattern:

1. The main tab rendering function `render_multi_timeframe_tab()` is defined in `tabs/multi_timeframe_tab.py`
2. The tab is registered in `app.py` in the `tabs` dictionary
3. Data processing, signal generation, and visualization are separated into distinct functions
4. Access to shared state (watchlist manager, strategy) is through Streamlit's session state

### Key Functions

- `render_multi_timeframe_tab()`: Main entry point that creates the UI layout
- `get_analyzed_data()`: Fetches and processes data for a specific timeframe
- `compute_signals()`: Generates buy/sell signals based on configured rules
- `plot_chart()`: Creates interactive Plotly candlestick charts with indicators
- `fetch_esg_data()`: Retrieves ESG ratings from Yahoo Finance
- `display_esg_data()`: Renders ESG data in a user-friendly format
- Timeframe-specific analysis functions: `long_term_analysis()`, `medium_term_analysis()`, `short_term_analysis()`

## Configuration

The tab uses a configuration-driven approach with a `TIMEFRAME_CONFIG` dictionary:

```python
TIMEFRAME_CONFIG = {
    "long": {
        "period": "5y",
        "interval": "1wk",
        "title": "Long-Term Weekly Chart",
        "indicators": {
            "sma": [50, 200],
            "ema": [50, 200],
            "rsi": 14,
            "macd": {"fast": 12, "slow": 26, "signal": 9}
        },
        "signals": {
            "buy": [
                {"type": "ma_cross", "fast": "SMA50", "slow": "SMA200", "direction": "above"},
                {"type": "rsi", "value": 50, "direction": "above", "weight": 0.5}
            ],
            "sell": [
                {"type": "ma_cross", "fast": "SMA50", "slow": "SMA200", "direction": "below"},
                {"type": "rsi", "value": 50, "direction": "below", "weight": 0.5}
            ],
            "min_score": 1.0
        }
    },
    # Medium and short timeframe configs follow the same pattern
}
```

This configuration-driven design makes it easy to:
- Add or modify indicators without changing the core logic
- Adjust signal rules without code changes
- Add new timeframes by defining additional config entries

## Technical Indicators

The feature calculates several types of technical indicators using the `pandas_ta` library:

- **Trend indicators**: Simple Moving Averages (SMA) and Exponential Moving Averages (EMA)
- **Momentum indicators**: Relative Strength Index (RSI) and Moving Average Convergence Divergence (MACD)
- **Volatility indicators**: Bollinger Bands
- **Volume indicators**: On-Balance Volume (OBV)

Indicator calculation is handled in the `get_analyzed_data()` function, which uses `pandas_ta` methods:

```python
# SMA indicators
for period in config["indicators"].get("sma", []):
    col_name = f'SMA{period}'
    df[col_name] = ta.sma(df['Close'], length=period)

# EMA indicators
for period in config["indicators"].get("ema", []):
    col_name = f'EMA{period}'
    df[col_name] = ta.ema(df['Close'], length=period)

# RSI
if "rsi" in config["indicators"]:
    period = config["indicators"]["rsi"]
    df['RSI'] = ta.rsi(df['Close'], length=period)

# MACD, Bollinger Bands, etc.
```

## Signal Generation

Trading signals are generated by the `compute_signals()` function, which evaluates a set of rules defined in the configuration:

- **Moving average crossovers**: When a faster MA crosses above/below a slower MA
- **RSI conditions**: When RSI crosses above/below threshold values
- **MACD signals**: When the MACD line crosses above/below the signal line
- **Bollinger Band bounces**: When price touches a Bollinger Band and reverses

Each rule has a weight, and signals are generated when the combined score exceeds the minimum threshold defined in the configuration.

Buy signals are marked with green upward triangles, and sell signals with red downward triangles on the charts.

## ESG Data Integration

The feature incorporates ESG (Environmental, Social, Governance) data from Yahoo Finance:

- **Data retrieval**: `fetch_esg_data()` function with fallback mechanisms
- **Display**: Color-coded ratings from "Negligible Risk" to "Severe Risk"
- **Explanation**: Information on how to interpret ESG scores

ESG data adds fundamental context to technical analysis and helps users identify companies with sustainable business practices.

## User Settings

Users can customize various aspects of the analysis:

- **RSI thresholds**: Adjust oversold and overbought levels
- **Moving average periods**: Change the length of short, medium, and long MAs
- **Bollinger Band parameters**: Modify length and standard deviation

These settings are stored in Streamlit's session state and applied to the analysis:

```python
st.session_state.mta_settings["rsi_oversold"] = st.slider(
    "RSI Oversold Threshold", 10, 40, 
    st.session_state.mta_settings["rsi_oversold"])
```

## How to Extend

### Adding a New Indicator

1. Add the indicator to the appropriate timeframe configuration:
```python
TIMEFRAME_CONFIG["medium"]["indicators"]["new_indicator"] = {"param1": value1, "param2": value2}
```

2. Add calculation logic in the `get_analyzed_data()` function:
```python
if "new_indicator" in config["indicators"]:
    params = config["indicators"]["new_indicator"]
    df['New_Indicator'] = ta.new_indicator(df['Close'], param1=params["param1"])
```

3. Use the indicator in signal rules:
```python
TIMEFRAME_CONFIG["medium"]["signals"]["buy"].append(
    {"type": "new_indicator", "value": threshold, "direction": "above"}
)
```

4. Add handling for the new rule type in `compute_signals()`

### Adding a New Timeframe

1. Add a new entry to `TIMEFRAME_CONFIG`:
```python
TIMEFRAME_CONFIG["intraday"] = {
    "period": "5d",
    "interval": "15m",
    "title": "Intraday Chart (15min)",
    "indicators": { /* ... */ },
    "signals": { /* ... */ }
}
```

2. Create a new analysis function (or reuse existing ones):
```python
def intraday_analysis(df, ticker):
    # Analysis specific to intraday timeframe
```

3. Add a new tab in the `render_multi_timeframe_tab()` function:
```python
tab_long, tab_med, tab_short, tab_intraday = st.tabs(["Long-Term", "Medium-Term", "Short-Term", "Intraday"])
# ...
with tab_intraday:
    st.subheader("Intraday Analysis (15min)")
    with st.spinner("Loading intraday data..."):
        df_intraday = get_analyzed_data(ticker, "intraday")
        intraday_analysis(df_intraday, ticker)
```

## Performance Considerations

Several techniques optimize performance:

- **Data caching**: The `@st.cache_data` decorator prevents redundant data fetching and processing
- **Efficient indicators**: Using `pandas_ta` for indicator calculation
- **Progress indicators**: `st.spinner()` provides feedback during lengthy operations
- **Error handling**: Graceful handling of missing data and errors
- **Lazy loading**: Each timeframe's data is only loaded when its tab is selected

To further improve performance:

- Consider adjusting the cache TTL (currently 3600 seconds) based on the update frequency needed
- For very large datasets, implement pagination or data sampling
- Monitor memory usage when processing many stocks with multiple timeframes
